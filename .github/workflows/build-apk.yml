name: Build Android APK

# 触发条件：手动触发或代码推送到main分支时触发
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ "main" ]
    paths: [ '**.py', 'requirements.txt', 'pyproject.toml' ]

# 环境变量
env:
  PYTHON_VERSION: '3.11'
  JAVA_VERSION: '17'

jobs:
  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest  # 使用最新的Ubuntu系统
    
    steps:
      # 第一步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # 第二步：设置Python环境
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      # 第三步：安装Python依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # 安装构建额外依赖（如果有）
          # pip install build
          
      # 第四步：设置Java环境（Flet构建APK需要）
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'zulu'  # 使用Zulu JDK
          
      # 第五步：验证环境
      - name: Verify environments
        run: |
          python --version
          java --version
          
      # 第六步：构建APK（核心步骤）
      - name: Build APK with Flet
        run: |
          # 查看当前目录结构
          ls -la
          # 查看配置文件
          cat pyproject.toml || echo "No pyproject.toml found"
          # 执行构建命令
          flet build apk --verbose
          
      # 第七步：上传构建产物
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: jgj59-scorer-apk
          path: build/apk/*.apk
          retention-days: 7  # 保留7天
          
      # 第八步：构建完成通知（可选）
      - name: Build completion notice
        if: success()
        run: echo "✅ APK构建成功！可在Artifacts中下载。"
        
      # 第九步：构建失败处理（可选）
      - name: Build failure notice
        if: failure()
        run: echo "❌ APK构建失败，请检查日志。"